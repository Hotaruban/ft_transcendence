# Hide Apache version information for security
ServerSignature Off
ServerTokens Prod
TraceEnable Off

# This virtual host listens on port 8443 and proxies requests to Nginx
<VirtualHost *:8443>
    ServerName localhost

    # Enable SSL/TLS for secure connections and SSL Certificate files
    SSLEngine on
    SSLCertificateFile "/etc/apache2/ssl/apache.crt"
    SSLCertificateKeyFile "/etc/apache2/ssl/apache.key"

    # Disable direct proxy requests (only reverse proxy is allowed)
    ProxyRequests Off

    # Preserve the original Host header when proxying requests
    ProxyPreserveHost On

    # Add this block to forward the Authorization header
    SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
    RequestHeader set Authorization "%{HTTP_AUTHORIZATION}e" env=HTTP_AUTHORIZATION

    # Reverse proxy to Nginx for handling static files, API, and WebSockets
    ProxyPass / http://nginx:8081/
    ProxyPassReverse / http://nginx:8081/

    # WebSockets proxy to Nginx
    ProxyPass /ws/ ws://nginx:8081/ws/
    ProxyPassReverse /ws/ ws://nginx:8080/ws/

    # API proxy to Nginx
    ProxyPass /api/ http://nginx:8081/api/
    ProxyPassReverse /api/ http://nginx:8081/api/

    # Ensure WebSocket connection headers are correctly set
    Header always set Connection upgrade
    Header always set Upgrade websocket
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Permissions-Policy "geolocation=(), microphone=()"

    # Disable ModSecurity for WebSockets (avoids interference with real-time traffic)
    <Location /ws/>
        SecRuleEngine Off
        ProxyPass ws://nginx:8081/ws/
        ProxyPassReverse ws://nginx:8081/ws/
    </Location>

    # Modify ModSecurity rules for API requests (avoids false positives)
    <LocationMatch "/api/.*">
        SecRuleRemoveById 920420 949110
    </LocationMatch>

    # Prevent access to hidden files (.git, .env, etc.)
    <Directory "/usr/local/apache2/htdocs">
        <FilesMatch "^\.(?!well-known/).*">
            Require all denied
        </FilesMatch>
    </Directory>

    # Enable gzip compression for text-based content
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
    </IfModule>

    # Enable cache expiration for static assets (Reduces requests for images, CSS, JS)
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 30 days"
        ExpiresByType image/jpeg "access plus 30 days"
        ExpiresByType image/png "access plus 30 days"
        ExpiresByType text/css "access plus 7 days"
        ExpiresByType application/javascript "access plus 7 days"
    </IfModule>

    # Logging settings (send logs to standard output/error for containerized environments)
    LogLevel info
    ErrorLog "/dev/stderr"
    CustomLog "/dev/stdout" combined

</VirtualHost>

<VirtualHost *:8080>
    ServerName localhost
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/server-status$
    RewriteRule ^(.*)$ https://%{HTTP_HOST}:8443$1 [R=301,L]
</VirtualHost>
